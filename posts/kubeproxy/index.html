<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Kube-proxy Explained with demo on Azure Kubernetes Service - zhengxin</title><link rel=icon type=image/png href=https://raw.githubusercontent.com/zhengxinzx/images/main/20240303214631.png><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="When I first touched Kubernetes, I can understand that there are master components like API server, scheduler, etc. and worker components, which is kubelet. However, I was confused about kube-proxy and the concept of CNI plugin: Why do we still need kube-proxy when we already have CNI plugin? Should not the CNI plugin be responsible for the proxying network packet among pods?
To answer these questions, we need to explain what is kube-proxy and how it works."><meta property="og:image" content="https://raw.githubusercontent.com/zhengxinzx/images/main/20240303214631.png"><meta property="og:url" content="https://zhengxin.online/posts/kubeproxy/"><meta property="og:site_name" content="zhengxin"><meta property="og:title" content="Kube-proxy Explained with demo on Azure Kubernetes Service"><meta property="og:description" content="When I first touched Kubernetes, I can understand that there are master components like API server, scheduler, etc. and worker components, which is kubelet. However, I was confused about kube-proxy and the concept of CNI plugin: Why do we still need kube-proxy when we already have CNI plugin? Should not the CNI plugin be responsible for the proxying network packet among pods?
To answer these questions, we need to explain what is kube-proxy and how it works."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-03T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-03T00:00:00+00:00"><meta property="article:tag" content="Networking"><meta property="article:tag" content="Kubernetes"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kube-proxy Explained with demo on Azure Kubernetes Service"><meta name=twitter:description content="When I first touched Kubernetes, I can understand that there are master components like API server, scheduler, etc. and worker components, which is kubelet. However, I was confused about kube-proxy and the concept of CNI plugin: Why do we still need kube-proxy when we already have CNI plugin? Should not the CNI plugin be responsible for the proxying network packet among pods?
To answer these questions, we need to explain what is kube-proxy and how it works."><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://zhengxin.online/css/main.cedbeeb0faeb84086f9984e91f32166984746a629a63df071897cc75ac92c4b7.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://zhengxin.online/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://zhengxin.online/>zhengxin</a></div><nav><a href=/>Home</a>
<a href=/posts>Blogs</a>
<a href=/tags>Tags</a>
| <span id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://zhengxin.online/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Kube-proxy Explained with demo on Azure Kubernetes Service</h1><div class=meta>Posted on May 3, 2024</div></div><section class=body><p>When I first touched Kubernetes, I can understand that there are master components like API server, scheduler, etc. and worker components, which is kubelet. However, I was confused about kube-proxy and the concept of CNI plugin: Why do we still need kube-proxy when we already have CNI plugin? Should not the CNI plugin be responsible for the proxying network packet among pods?</p><p>To answer these questions, we need to explain what is kube-proxy and how it works.</p><h2 id=what-is-kube-proxy>What is Kube-proxy</h2><p>Kube-proxy is a process that runs on each worker node in the cluster. It can be hosted by a DaemonSet, or simply a process running on the node. Kube-proxy plays the role as a network rule configurator, which set up the network rule on the node, so that the network packet sent to/from the node can be routed to the correct pod. Based on these rules, Kubernetes provides the concept of service, which maps a virtual IP to a set of pods.</p><p>The difference between CNI plugin and kube-proxy is quite straightforward: CNI plugin solves the problem of how to build connection between pods, and kube-proxy solves the problem of which pod a network packet should be sent to.</p><blockquote><p>Kube-proxy is not strictly required for a kubernetes cluster. In Amazon EKS (Elastic Kubernetes Service), kube-proxy is an optional add-on. In fact, some CNI plugin are able to provide the same functionality as kube-proxy, such as Cilium.</p></blockquote><h2 id=how-it-works>How it works</h2><p>When a service, for example a ClusterIP service, is created in the kubernetes cluster,</p><ol><li>A virtual IP as assigned with the service. The virtual IP does not belong to any pod.</li><li>An endpoints object is created, which contains the IP addresses of the pods that the service is targeting.</li></ol><p>On every worker node, kube-proxy listen for the changes/addition/deletion of endpoints object, and create network rules based on iptables/ipvs/nftables so that the network packet sent to the virtual IP will be sent to one of the IP addresses in the endpoints object. The virtual IP appears like a real IP address to the sender, where the packet was sent to a backend pod.</p><p><strong>The kube-proxy itself does not handle any network packet</strong>.</p><p>Today, the default mode of kube-proxy is iptables. You can find my post about iptables at <a href=./iptables.md>Iptables explore, implement virtual IP</a>.</p><h2 id=demo>Demo</h2><p>Nothing can explain better than a real demo, and let&rsquo;s see how kube-proxy works on setting up the iptables rules.</p><p>In this demo, I will use an Azure Kubernetes Cluster (AKS) with two nodes, the cluster is configured to use the Azure CNI plugin.</p><h3 id=preparation>Preparation</h3><h2 id=clusterip>ClusterIP</h2><h2 id=nodeport>NodePort</h2><h2 id=setup>Setup</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>‚ùØ kubectl get nodes
</span></span><span style=display:flex><span>NAME                                STATUS   ROLES   AGE     VERSION
</span></span><span style=display:flex><span>aks-agentpool-39551181-vmss000000   Ready    agent   4m19s   v1.28.5
</span></span><span style=display:flex><span>aks-agentpool-39551181-vmss000001   Ready    agent   4m12s   v1.28.5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl debug node/aks-agentpool-39551181-vmss000000 -it --image<span style=color:#666>=</span>ubuntu
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apt install libcap2-bin iptables
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>setcap CAP_NET_RAW,CAP_NET_ADMIN+ep /usr/sbin/xtables-nft-multi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl debug node/aks-agentpool-39551181-vmss000000 -it <span style=color:#b83838>`</span>
</span></span><span style=display:flex><span>--image<span style=color:#666>=</span>ubuntu <span style=color:#b83838>`</span>
</span></span><span style=display:flex><span>--overrides<span style=color:#666>=</span><span style=color:#b83838>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#b83838>  &#34;apiVersion&#34;: &#34;v1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b83838>  &#34;kind&#34;: &#34;Pod&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b83838>  &#34;spec&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#b83838>    &#34;containers&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#b83838>      {
</span></span></span><span style=display:flex><span><span style=color:#b83838>        &#34;name&#34;: &#34;debug-container&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b83838>        &#34;image&#34;: &#34;ubuntu&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b83838>        &#34;securityContext&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#b83838>          &#34;capabilities&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#b83838>            &#34;add&#34;: [&#34;NET_ADMIN&#34;]
</span></span></span><span style=display:flex><span><span style=color:#b83838>          }
</span></span></span><span style=display:flex><span><span style=color:#b83838>        }
</span></span></span><span style=display:flex><span><span style=color:#b83838>      }
</span></span></span><span style=display:flex><span><span style=color:#b83838>    ]
</span></span></span><span style=display:flex><span><span style=color:#b83838>  }
</span></span></span><span style=display:flex><span><span style=color:#b83838>}&#39;</span>
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/networking>Networking</a></li><li><a href=/tags/kubernetes>Kubernetes</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/zhengxinzx rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=mailto:xin.zheng.0459@outlook.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a></div><div class=footer-info>2024 ¬© zhengxin</div></footer><script>feather.replace()</script></div></body></html>